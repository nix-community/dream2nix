<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Contributing - dream2nix documentation</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Guides</li><li class="chapter-item expanded "><a href="../guides/getting-started-python.html"><strong aria-hidden="true">2.</strong> Python: getting started in 10 minutes</a></li><li class="chapter-item expanded "><a href="../guides/getting-started-nodejs.html"><strong aria-hidden="true">3.</strong> Node.js: quickstart</a></li><li class="chapter-item expanded affix "><li class="part-title">Subsystems</li><li class="chapter-item expanded "><a href="../subsystems/rust.html"><strong aria-hidden="true">4.</strong> Rust</a></li><li class="chapter-item expanded "><a href="../subsystems/python.html"><strong aria-hidden="true">5.</strong> Python</a></li><li class="chapter-item expanded "><a href="../subsystems/node.html"><strong aria-hidden="true">6.</strong> Node.js</a></li><li class="chapter-item expanded "><a href="../subsystems/haskell.html"><strong aria-hidden="true">7.</strong> Haskell</a></li><li class="chapter-item expanded "><a href="../subsystems/php.html"><strong aria-hidden="true">8.</strong> PHP</a></li><li class="chapter-item expanded affix "><li class="part-title">Concepts / API</li><li class="chapter-item expanded "><a href="../intro/architecture.html"><strong aria-hidden="true">9.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../intro/translators.html"><strong aria-hidden="true">10.</strong> Translators</a></li><li class="chapter-item expanded "><a href="../api/generic-lock.html"><strong aria-hidden="true">11.</strong> Generic Lockfile</a></li><li class="chapter-item expanded "><a href="../intro/indexers.html"><strong aria-hidden="true">12.</strong> Indexers</a></li><li class="chapter-item expanded "><a href="../intro/fetchers.html"><strong aria-hidden="true">13.</strong> Fetchers</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> Builders</div></li><li class="chapter-item expanded "><a href="../intro/override-system.html"><strong aria-hidden="true">15.</strong> Override system</a></li><li class="chapter-item expanded affix "><li class="part-title">Correlation with nixpkgs</li><li class="chapter-item expanded "><a href="../intro/nixpkgs-improvements.html"><strong aria-hidden="true">16.</strong> Nixpkgs improvements</a></li><li class="chapter-item expanded affix "><li class="part-title">Contributing</li><li class="chapter-item expanded "><a href="../extending-dream2nix.html"><strong aria-hidden="true">17.</strong> Extending dream2nix</a></li><li class="chapter-item expanded "><a href="../contributing/contributing.html" class="active"><strong aria-hidden="true">18.</strong> Contributing</a></li><li class="chapter-item expanded affix "><li class="part-title">Development Roundups</li><li class="chapter-item expanded "><a href="../development-roundups/2022-april-june.html"><strong aria-hidden="true">19.</strong> April - June 2022</a></li><li class="chapter-item expanded "><a href="../development-roundups/2022-july-september.html"><strong aria-hidden="true">20.</strong> July - September 2022</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">dream2nix documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dream2nix-contributors-guide"><a class="header" href="#dream2nix-contributors-guide">dream2nix contributors guide</a></h1>
<p>This guide is for you if you plan to implement support for a new subsystem in dream2nix, like for example for a new programming language.</p>
<p>If the ecosystem you are interested in is already supported by dream2nix, but you want to add support for a new type of lock-file format, this guide is still an interesting read in order to better understand the parts a dream2nix subsystem consists of.</p>
<h2 id="breakdown-of-a-subsystem"><a class="header" href="#breakdown-of-a-subsystem">Breakdown of a subsystem</a></h2>
<p>A new subsystem in dream2nix is initialized by adding 3 files:</p>
<ul>
<li>one translator module</li>
<li>one builder module</li>
<li>one example flake.nix for testing the subsystem</li>
</ul>
<p>It's also highly recommended to implement a discoverer module, so that projects of that subsystem can be detected automatically by dream2nix. This simplifies the UX. It won't be necessary anymore for the user to understand which ecosystem and which translator must be used in order to build packages from a certain source tree.</p>
<h2 id="translator-notes"><a class="header" href="#translator-notes">Translator Notes</a></h2>
<p>The task of a translator is to inspect a given source tree, parse some of the files, and extract information about a projects dependencies and how it must be built.</p>
<p>In general there are 3 different types of translators.
No matter which type, all translators always produce the same output structure which is called <code>dream-lock</code>.<br />
An example of this structure can be found <a href="https://github.com/nix-community/dream2nix/blob/main/src/specifications/dream-lock-example.json">here</a>.<br />
There is also a <a href="https://github.com/nix-community/dream2nix/blob/main/src/specifications/dream-lock-schema.json">jsonschema specification</a> for it.</p>
<h2 id="translator-types"><a class="header" href="#translator-types">Translator types</a></h2>
<p>The different types of translators have the following properties:</p>
<ol>
<li>
<p>pure translator</p>
<ul>
<li>returns the dream-lock as a nix attribute set</li>
<li>translation logic is implemented in nix language only</li>
<li>parsing of files and data extraction is all done during eval time</li>
<li>does not invoke a build or read from any build output</li>
</ul>
</li>
<li>
<p>pure translator utilizing IFD (import from derivation)</p>
<ul>
<li>returns the dream-lock as a nix attribute set</li>
<li>a nix build is used in order to parse files and extract data</li>
<li>translation logic can be implemented in arbitrary language</li>
<li>the result is parsed back into nix from the build output</li>
<li>downside: performance impact on evaluation time</li>
</ul>
</li>
<li>
<p>impure translator</p>
<ul>
<li>returns the dream-lock by dumping a dream-lock.json file</li>
<li>translator can be any executable program running independent of nix</li>
<li>not constrained in any way (can do arbitrary network access etc.)</li>
<li>downside: requires the user to run a command whenever dependencies got updated</li>
</ul>
</li>
</ol>
<h2 id="which-translator-type-to-start-with"><a class="header" href="#which-translator-type-to-start-with">Which translator type to start with?</a></h2>
<p>When adding support for a new ecosystem/language, the following strategy usually works out:</p>
<p>If there exists tooling within that ecosystem that can create some kind of lock file (with URLs + checksums), implement a pure translator for that lock file format first.</p>
<p>After that, we might still need an impure translator for all the projects within that ecosystem that don't ship a lock-file. But given the fact that we already have one pure translator, all the impure translator needs to do is to run the tooling that creates the lock file and call out to the pure translator via <code>nix eval</code>.</p>
<p>If the ecosystem does not have any kind of lock file format, then only an impure translator is needed. In this case it needs to be more complex and implement some kind of routine for retrieving all URL's and hashes of the dependencies, by, for example, downloading them all and hashing them.</p>
<h2 id="initializing-the-subsystm"><a class="header" href="#initializing-the-subsystm">Initializing the subsystm</a></h2>
<p>To initialize a new subsystem, we will:</p>
<ul>
<li>declare a few shell variables</li>
<li>initialize a translator and a builder from templates</li>
<li>initialize an example flake.nix to test the implementation</li>
</ul>
<h3 id="declare-env-variables"><a class="header" href="#declare-env-variables">declare env variables</a></h3>
<p>Navigate to your dream2nix checkout and execute:</p>
<pre><code class="language-bash">export dream2nix=$(realpath .)

# define names for new modules (pick names matching to your subsystem)
export subsystem=&quot;my-subsystem&quot; # example: nodejs
export pureTranslator=&quot;my-pure-translator&quot; # example: package-lock
export impureTranslator=&quot;my-impure-translator&quot; # example: package-json
export builder=&quot;my-builder&quot; # pick `default` as name if not sure

# define path to example flake
export myFlake=&quot;$dream2nix/examples/$subsystem&quot;
</code></pre>
<h3 id="initialize-templates"><a class="header" href="#initialize-templates">initialize templates</a></h3>
<pre><code class="language-bash"># initialize pure translator
mkdir -p $dream2nix/src/subsystems/$subsystem/translators/$pureTranslator
cp $dream2nix/src/templates/translators/pure.nix $dream2nix/src/subsystems/$subsystem/translators/$pureTranslator/default.nix

# initialize builder
mkdir -p $dream2nix/src/subsystems/$subsystem/builders/$builder
cp $dream2nix/src/templates/builders/default.nix $dream2nix/src/subsystems/$subsystem/builders/$builder/default.nix
</code></pre>
<h3 id="initialize-example-flakenix"><a class="header" href="#initialize-example-flakenix">initialize example flake.nix</a></h3>
<p>Initialize the flake from a template and edit it to reference the names of your subsystem correctly.</p>
<pre><code class="language-bash"># initialize example flake
mkdir -p $myFlake
cp $dream2nix/tests/integration/tests/contribute/my-flake.nix $myFlake/flake.nix
</code></pre>
<p>Now edit the flake and ensure that <code>my-subsystem</code>, <code>my-pure-translator</code>, are replaced with the names defined earlier.</p>
<h3 id="add-new-files-to-git"><a class="header" href="#add-new-files-to-git">add new files to git</a></h3>
<p>This is required, otherwise nix flakes won't see the new files.</p>
<pre><code class="language-bash">git add .
</code></pre>
<h3 id="test-example-flake"><a class="header" href="#test-example-flake">test example flake</a></h3>
<p>Always pass <code>--override-input dream2nix $dream2nix</code> in order to evaluate the example flake against your local checkout of dream2nix.</p>
<p>In the following bash snippet, arguments containing a '<code>#</code>' symbol are wrongfully highlighted as comment but are in fact required parameters.</p>
<p>Run all of the following commands now to ensure that all templates have been initialized correctly</p>
<pre><code class="language-bash"># inspect if your subsystem exports any package/devShell
nix flake show $myFlake --override-input dream2nix $dream2nix --show-trace

# run your translator and dump the dream-lock.json for inspection
nix run $myFlake#default.resolve --override-input dream2nix $dream2nix --show-trace

# test if the default package builds
nix build $myFlake#default --override-input dream2nix $dream2nix --show-trace
</code></pre>
<h2 id="iterate-on-the-subsystem"><a class="header" href="#iterate-on-the-subsystem">Iterate on the subsystem</a></h2>
<p>By default the templates implement a subsystem for <code>niv</code>. It reads niv's <code>./nix/sources.json</code> and builds a package for it containing the niv inputs.</p>
<p>The output of this is not useful, but demonstrates how a dream2nix translator/builder works.</p>
<p>You can now start modifying the builder/translator to implement the logic required by your subsystem.</p>
<p>You can test your implementation by executing the <code>nix flake show</code>, <code>nix build</code>, <code>nix run</code> commands from the last step above.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../extending-dream2nix.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../development-roundups/2022-april-june.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../extending-dream2nix.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../development-roundups/2022-april-june.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
